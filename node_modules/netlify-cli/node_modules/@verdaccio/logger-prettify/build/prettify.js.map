{"version":3,"file":"prettify.js","names":["noop","buildSafeSonicBoom","opts","stream","SonicBoom","on","filterBrokenPipe","sync","isMainThread","setupOnExit","err","code","write","end","flushSync","destroy","removeListener","global","WeakRef","WeakMap","FinalizationRegistry","onExit","require","register","autoEnd","unregister","eventName","destroyed","flush","hasColors","colors","isColorSupported","buildPretty","chunk","printMessage","prettyStamp","pretty","build","source","Transform","objectMode","autoDestroy","transform","enc","cb","line","destination","dest","pipeline","console","error"],"sources":["../src/prettify.ts"],"sourcesContent":["import { isColorSupported } from 'colorette';\nimport { WriteStream } from 'fs';\nimport build from 'pino-abstract-transport';\nimport SonicBoom, { SonicBoomOpts } from 'sonic-boom';\nimport { Transform, pipeline } from 'stream';\nimport { isMainThread } from 'worker_threads';\n\nimport { fillInMsgTemplate, printMessage } from './formatter';\nimport { PrettyOptionsExtended } from './types';\n\nexport { fillInMsgTemplate };\n\nfunction noop() {}\n\n/**\n * Creates a safe SonicBoom instance\n *\n * @param {object} opts Options for SonicBoom\n *\n * @returns {object} A new SonicBoom stream\n */\nfunction buildSafeSonicBoom(opts: SonicBoomOpts) {\n  const stream = new SonicBoom(opts);\n  stream.on('error', filterBrokenPipe);\n  if (!opts.sync && isMainThread) {\n    setupOnExit(stream);\n  }\n  return stream;\n\n  function filterBrokenPipe(err) {\n    if (err.code === 'EPIPE') {\n      // @ts-ignore\n      stream.write = noop;\n      stream.end = noop;\n      stream.flushSync = noop;\n      stream.destroy = noop;\n      return;\n    }\n    stream.removeListener('error', filterBrokenPipe);\n  }\n}\n\nfunction setupOnExit(stream) {\n  /* istanbul ignore next */\n  if (global.WeakRef && global.WeakMap && global.FinalizationRegistry) {\n    // This is leak free, it does not leave event handlers\n    const onExit = require('on-exit-leak-free');\n\n    onExit.register(stream, autoEnd);\n\n    stream.on('close', function () {\n      onExit.unregister(stream);\n    });\n  }\n}\n\n/* istanbul ignore next */\nfunction autoEnd(stream, eventName) {\n  // This check is needed only on some platforms\n\n  if (stream.destroyed) {\n    return;\n  }\n\n  if (eventName === 'beforeExit') {\n    // We still have an event loop, let's use it\n    stream.flush();\n    stream.on('drain', function () {\n      stream.end();\n    });\n  } else {\n    // We do not have an event loop, so flush synchronously\n    stream.flushSync();\n  }\n}\n\nexport function hasColors(colors: boolean | undefined) {\n  if (colors) {\n    return isColorSupported;\n  }\n  return typeof colors === 'undefined' ? true : colors;\n}\n\nexport function buildPretty(opts: PrettyOptionsExtended) {\n  return (chunk) => {\n    const colors = hasColors(opts.colors);\n    return printMessage(chunk, { prettyStamp: opts.prettyStamp }, colors);\n  };\n}\n\nexport default function (opts) {\n  const pretty = buildPretty(opts);\n  // @ts-ignore\n  return build(function (source) {\n    const stream = new Transform({\n      objectMode: true,\n      autoDestroy: true,\n      transform(chunk, enc, cb) {\n        const line = pretty(chunk) + '\\n';\n        cb(null, line);\n      },\n    });\n    const destination = buildSafeSonicBoom({\n      dest: opts.destination || 1,\n      sync: opts.sync || true,\n    }) as unknown as WriteStream;\n\n    source.on('unknown', function (line) {\n      destination.write(line + '\\n');\n    });\n\n    pipeline(source, stream, destination, (err) => {\n      // eslint-disable-next-line no-console\n      console.error('prettify pipeline error ', err);\n    });\n    return stream;\n  });\n}\n"],"mappings":"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"}